<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THC Remote Scan</title>
    <style>
        body {
            margin: 0;
            background: #000;
            color: #0f0;
            font-family: -apple-system, system-ui;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            overflow: hidden;
        }

        #ui {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .status {
            font-size: 24px;
            font-weight: bold;
        }

        .sub {
            color: #888;
            margin-top: 10px;
        }

        #hiddenInput {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .success {
            color: #0f0;
            display: none;
        }

        .error {
            color: #f44;
            display: none;
        }

        /* Log Panel */
        #log-panel {
            width: 100%;
            height: 150px;
            background: rgba(20, 20, 20, 0.9);
            border-top: 1px solid #333;
            font-family: monospace;
            font-size: 11px;
            color: #aaa;
            text-align: left;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
            box-sizing: border-box;
        }

        .log-entry {
            margin-bottom: 2px;
            border-bottom: 1px solid #222;
        }

        .log-time {
            color: #555;
            margin-right: 5px;
        }

        .log-info {
            color: #42b4e6;
        }

        .log-success {
            color: #2ea750;
        }

        .log-error {
            color: #f44;
        }
    </style>
</head>

<body>
    <input type="text" id="hiddenInput" autocomplete="off" />
    <div id="ui">
        <div id="ready">
            <div class="status">üü¢ Ready to Scan</div>
            <div class="sub" id="loc-info">Waiting for Sale ID...</div>
        </div>
        <div id="sending" style="display:none;">
            <div class="status">üì§ Sending...</div>
        </div>
        <div id="success" class="success">
            <div class="status">‚úÖ Scan Sent!</div>
            <div class="sub">Check the main app.</div>
        </div>
        <div id="error" class="error">
            <div class="status">‚ùå Error Sending Scan</div>
            <div id="errorMsg" class="sub"></div>
        </div>
    </div>

    <!-- Debug Log Panel -->
    <div id="log-panel"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const saleId = urlParams.get('sale_id');
        const locInfo = document.getElementById('loc-info');
        const logPanel = document.getElementById('log-panel');
        const input = document.getElementById('hiddenInput');
        const readyUi = document.getElementById('ready');
        const sendingUi = document.getElementById('sending');
        const successUi = document.getElementById('success');
        const errorUi = document.getElementById('error');
        const errorMsg = document.getElementById('errorMsg');

        function addLog(msg, type = '') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + (type ? 'log-' + type : '');
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
            logPanel.prepend(entry);
        }

        if (saleId) {
            locInfo.textContent = `Sale ID: ${saleId}`;
            addLog(`Initialized for Sale: ${saleId}`, 'info');
        } else {
            addLog('WARNING: No Sale ID provided', 'error');
        }

        function forceFocus() { input.focus(); }
        document.body.onclick = forceFocus;
        setInterval(forceFocus, 1000);
        forceFocus();

        let buffer = '';
        let timer = null;

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                addLog(`[KEY] ENTER (Buffer: ${buffer.length})`, 'info');
                if (buffer.length > 10) submitScan();
                e.preventDefault();
            } else if (e.key.length === 1) {
                buffer += e.key;
                addLog(`[KEY] ${e.key} (Total: ${buffer.length})`);
                clearTimeout(timer);
                timer = setTimeout(() => {
                    if (buffer.length > 10) {
                        addLog('Auto-submitting long buffer...', 'info');
                        submitScan();
                    }
                }, 800);
            }
        });

        async function submitScan() {
            if (!saleId) { showErr('No sale_id found'); return; }

            const scanData = buffer;
            buffer = '';
            input.value = '';

            readyUi.style.display = 'none';
            sendingUi.style.display = 'block';
            successUi.style.display = 'none';
            errorUi.style.display = 'none';

            addLog(`SENDING SCAN: ${scanData.substring(0, 10)}...`, 'info');

            try {
                const response = await fetch(`/api/sales/${saleId}/verify-bluetooth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ barcodeData: scanData, isRemote: true })
                });
                const data = await response.json();
                if (data.success) {
                    addLog('SCAN APPROVED BY BACKEND', 'success');
                    sendingUi.style.display = 'none';
                    successUi.style.display = 'block';
                    setTimeout(() => {
                        successUi.style.display = 'none';
                        readyUi.style.display = 'block';
                    }, 3000);
                } else {
                    addLog(`REJECTED: ${data.reason}`, 'error');
                    showErr(data.reason || 'Server Error');
                }
            } catch (e) {
                addLog('CONNECTION FAILED', 'error');
                showErr('Connection failed');
            }
        }

        function showErr(msg) {
            sendingUi.style.display = 'none';
            errorUi.style.display = 'block';
            errorMsg.textContent = msg;
            setTimeout(() => {
                errorUi.style.display = 'none';
                readyUi.style.display = 'block';
            }, 3000);
        }
    </script>
</body>

</html>