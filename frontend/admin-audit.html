<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manager Dashboard - Transaction Audit</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #0f172a;
      color: #f4f6ff;
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      background: rgba(59, 130, 246, 0.18);
      border: 1px solid rgba(59, 130, 246, 0.35);
    }

    .pill.bad {
      background: rgba(239, 68, 68, 0.18);
      border-color: rgba(239, 68, 68, 0.35);
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    select,
    button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: #f4f6ff;
      font-size: 14px;
    }

    button {
      cursor: pointer;
      background: rgba(46, 167, 80, 0.25);
      border-color: rgba(46, 167, 80, 0.35);
      font-weight: 600;
    }

    button:active {
      transform: scale(0.99);
    }

    .card {
      background: rgba(30, 41, 59, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.10);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
    }

    .muted {
      color: rgba(244, 246, 255, 0.65);
      font-size: 12px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      overflow: hidden;
      border-radius: 14px;
      background: rgba(30, 41, 59, 0.55);
      border: 1px solid rgba(255, 255, 255, 0.10);
    }

    th,
    td {
      text-align: left;
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 13px;
      vertical-align: top;
      word-break: break-word;
    }

    th {
      font-size: 12px;
      color: rgba(244, 246, 255, 0.65);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(15, 23, 42, 0.6);
    }

    tr.missing-note td {
      background: rgba(239, 68, 68, 0.08);
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
    }

    .badge.ok {
      background: rgba(46, 167, 80, 0.22);
      border-color: rgba(46, 167, 80, 0.35);
    }

    .badge.warn {
      background: rgba(245, 158, 11, 0.18);
      border-color: rgba(245, 158, 11, 0.35);
    }

    .badge.bad {
      background: rgba(239, 68, 68, 0.18);
      border-color: rgba(239, 68, 68, 0.35);
    }

    .nav-links {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-link {
      color: #93c5fd;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>Transaction Audit</h1>
    <div id="summaryPill" class="pill">Loading…</div>
  </div>

  <div class="controls">
    <select id="statusSelect">
      <option value="CLOSED" selected>CLOSED</option>
      <option value="OPEN">OPEN</option>
    </select>
    <select id="limitSelect">
      <option value="25">25</option>
      <option value="50" selected>50</option>
      <option value="100">100</option>
      <option value="200">200</option>
    </select>
    <button onclick="loadAudit()">Refresh</button>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap;">
      <div>
        <div style="font-weight:700;">Notification Center</div>
        <div class="muted">Flags transactions missing an “ID Check …” note.</div>
      </div>
      <div class="muted" id="lastUpdated">—</div>
    </div>
    <div id="missingList" class="muted" style="margin-top:10px;">Loading…</div>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Sale</th>
        <th>Status</th>
        <th>Total</th>
        <th>ID Note</th>
        <th>Verification</th>
        <th>Updated</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr>
        <td colspan="6" class="muted">Loading…</td>
      </tr>
    </tbody>
  </table>

  <div class="nav-links">
    <a href="admin-scans.html" class="nav-link">All Scans</a>
    <a href="admin-banned.html" class="nav-link">Banned Customers</a>
    <a href="admin-overrides.html" class="nav-link">Override History</a>
  </div>

  <script>
    function fmtMoney(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return '—';
      return `$${num.toFixed(2)}`;
    }

    function fmtDate(value) {
      if (!value) return '—';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return '—';
      return d.toLocaleString();
    }

    function makeSaleLink(id) {
      if (!id) return '—';
      const href = `https://retail.lightspeed.app/sales/${encodeURIComponent(id)}?platform=ios&action=view`;
      return `<a href="${href}" target="_blank" rel="noreferrer" class="nav-link" style="color:#93c5fd;">${id}</a>`;
    }

    async function loadAudit() {
      const status = document.getElementById('statusSelect').value;
      const limit = document.getElementById('limitSelect').value;
      const tbody = document.getElementById('tbody');
      const summaryPill = document.getElementById('summaryPill');
      const missingList = document.getElementById('missingList');
      const lastUpdated = document.getElementById('lastUpdated');

      tbody.innerHTML = `<tr><td colspan="6" class="muted">Loading…</td></tr>`;
      summaryPill.textContent = 'Loading…';
      summaryPill.className = 'pill';
      missingList.textContent = 'Loading…';

      try {
        const params = new URLSearchParams({ status, limit });
        const res = await fetch(`/admin/transactions?${params}`, { cache: 'no-store' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Failed to load transactions');

        const items = data.transactions || [];
        const missing = items.filter(x => x.missingNote);

        lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

        if (missing.length > 0) {
          summaryPill.textContent = `${missing.length} missing ID note`;
          summaryPill.className = 'pill bad';
          const preview = missing.slice(0, 10).map(x => x.sale_id).join(', ');
          missingList.innerHTML = `<span class="badge bad">Missing notes</span> ${preview}${missing.length > 10 ? '…' : ''}`;
        } else {
          summaryPill.textContent = 'All good (no missing notes)';
          summaryPill.className = 'pill';
          missingList.innerHTML = `<span class="badge ok">OK</span> No missing notes in this list.`;
        }

        if (items.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="muted">No transactions returned.</td></tr>`;
          return;
        }

        tbody.innerHTML = items.map((t) => {
          const noteBadge = t.hasIdNote
            ? `<span class="badge ok">${t.noteStatus || 'ID NOTE'}</span> ${t.noteAge ? `Age ${t.noteAge}` : ''} ${t.noteDobYear ? `DOB ${t.noteDobYear}` : ''}`
            : `<span class="badge bad">MISSING</span>`;

          const verBadge = t.hasVerification
            ? `<span class="badge ${String(t.verification_status || '').startsWith('approved') ? 'ok' : 'warn'}">${t.verification_status}</span> ${t.verification_age ? `Age ${t.verification_age}` : ''}`
            : `<span class="badge warn">NO DB</span>`;

          const rowClass = t.missingNote ? 'missing-note' : '';

          return `
            <tr class="${rowClass}">
              <td>${makeSaleLink(t.sale_id)}</td>
              <td>${t.status || '—'}</td>
              <td>${fmtMoney(t.total)}</td>
              <td>${noteBadge}</td>
              <td>${verBadge}</td>
              <td>${fmtDate(t.updated_at || t.created_at)}</td>
            </tr>
          `;
        }).join('');

      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="6" class="muted">Error: ${e.message}</td></tr>`;
        summaryPill.textContent = 'Error';
        summaryPill.className = 'pill bad';
        missingList.textContent = e.message;
      }
    }

    loadAudit();
    setInterval(loadAudit, 30000);
  </script>
</body>

</html>

