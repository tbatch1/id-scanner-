<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manager Dashboard - Data Center</title>
  <link rel="stylesheet" href="/frontend/admin-shared.css" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1220;
      --panel: rgba(17, 24, 39, 0.65);
      --border: rgba(255, 255, 255, 0.10);
      --text: #f4f6ff;
      --muted: rgba(244, 246, 255, 0.65);
      --blue: #60a5fa;
      --green: #34d399;
      --amber: #fbbf24;
      --red: #fb7185;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, rgba(90, 84, 255, 0.22), transparent 55%),
        radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.16), transparent 50%),
        var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 16px 28px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.02em;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      background: rgba(96, 165, 250, 0.14);
      border: 1px solid rgba(96, 165, 250, 0.35);
      color: #dbeafe;
      white-space: nowrap;
    }

    .pill.warn {
      background: rgba(251, 191, 36, 0.14);
      border-color: rgba(251, 191, 36, 0.35);
      color: #fef3c7;
    }

    .pill.bad {
      background: rgba(251, 113, 133, 0.14);
      border-color: rgba(251, 113, 133, 0.35);
      color: #ffe4e6;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    select,
    button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      font-size: 14px;
    }

    button {
      cursor: pointer;
      border-color: rgba(52, 211, 153, 0.35);
      background: rgba(52, 211, 153, 0.14);
      font-weight: 650;
    }

    button.secondary {
      border-color: rgba(96, 165, 250, 0.35);
      background: rgba(96, 165, 250, 0.14);
      color: #dbeafe;
    }

    button:active {
      transform: scale(0.99);
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 14px;
    }

    @media (max-width: 1100px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 720px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }

    .kpi {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .kpi .value {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.01em;
    }

    .kpi .label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .kpi .delta {
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .section-title {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      margin: 16px 0 8px;
      flex-wrap: wrap;
    }

    .section-title h2 {
      margin: 0;
      font-size: 15px;
      color: #e5e7eb;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .table-wrap {
      overflow-x: auto;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 720px;
    }

    th,
    td {
      padding: 12px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 13px;
      text-align: left;
      vertical-align: top;
      word-break: break-word;
    }

    th {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(15, 23, 42, 0.55);
      position: sticky;
      top: 0;
    }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <h1>Data Center</h1>
      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <div class="pill" id="snapshotPill">Loading snapshots…</div>
        <div class="pill" id="compliancePill">Checking compliance…</div>
      </div>
    </div>

    <nav class="admin-top-nav" aria-label="Admin navigation">
      <a class="admin-top-nav__brand" href="/admin/data-center.html" aria-label="THC Club Admin Home">
        <img src="/frontend/assets/thc-logo.png" alt="THC Club" />
      </a>
      <a href="/admin/data-center.html" class="admin-top-nav__link">Manager Dashboard</a>
      <a href="/admin/marketing.html" class="admin-top-nav__link">Marketing Analytics</a>
      <a href="/admin/scans.html" class="admin-top-nav__link">View All Scans</a>
      <a href="/admin/audit.html" class="admin-top-nav__link">Transaction Audit</a>
      <a href="/admin/banned.html" class="admin-top-nav__link">Banned Customers</a>
    </nav>
    <div class="admin-top-nav-spacer" aria-hidden="true"></div>

    <div class="controls">
      <select id="daysSelect">
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="365">Last 365 days</option>
      </select>

      <select id="outletSelect">
        <option value="">All Outlets</option>
      </select>

      <button class="secondary" id="refreshBtn">Refresh Now</button>
    </div>

    <div class="muted" id="lastUpdated">—</div>

    <div class="grid">
      <div class="card">
        <div class="kpi">
          <div>
            <div class="label">Revenue</div>
            <div class="value" id="kpiRevenue">—</div>
          </div>
          <div class="delta" id="kpiRevenueMeta">—</div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div>
            <div class="label">Transactions</div>
            <div class="value" id="kpiTransactions">—</div>
          </div>
          <div class="delta" id="kpiTransactionsMeta">—</div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div>
            <div class="label">Avg Ticket</div>
            <div class="value" id="kpiAvgTicket">—</div>
          </div>
          <div class="delta" id="kpiAvgTicketMeta">—</div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div>
            <div class="label">Items Sold</div>
            <div class="value" id="kpiItemsSold">—</div>
          </div>
          <div class="delta" id="kpiItemsSoldMeta">—</div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div>
            <div class="label">Unique Customers</div>
            <div class="value" id="kpiCustomers">—</div>
          </div>
          <div class="delta" id="kpiCustomersMeta">—</div>
        </div>
      </div>
    </div>

    <div class="section-title">
      <h2>Top Products</h2>
      <div class="muted" id="topProductsMeta">—</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Product</th>
            <th>SKU</th>
            <th>Qty</th>
            <th>Revenue</th>
            <th>Txns</th>
          </tr>
        </thead>
        <tbody id="topProductsBody">
          <tr>
            <td colspan="5" class="muted">Loading…</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="section-title">
      <h2>Low Stock</h2>
      <div class="muted" id="lowStockMeta">—</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Outlet</th>
            <th>Product</th>
            <th>SKU</th>
            <th>On Hand</th>
            <th>Reorder Pt</th>
          </tr>
        </thead>
        <tbody id="lowStockBody">
          <tr>
            <td colspan="5" class="muted">Loading…</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="section-title">
      <h2>Top Customers</h2>
      <div class="muted" id="topCustomersMeta">—</div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Customer</th>
            <th>Email</th>
            <th>Txns</th>
            <th>Spend</th>
            <th>Avg Ticket</th>
          </tr>
        </thead>
        <tbody id="topCustomersBody">
          <tr>
            <td colspan="5" class="muted">Loading…</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    async function apiFetch(path, options = {}) {
      const headers = new Headers(options.headers || {});
      return fetch(path, { ...options, headers });
    }

    function fmtMoney(value) {
      const n = Number(value || 0);
      return n.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
    }

    function fmtInt(value) {
      const n = Number(value || 0);
      return Number.isFinite(n) ? n.toLocaleString() : '0';
    }

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    async function loadOutlets() {
      try {
        const res = await apiFetch('/admin/outlets', { cache: 'no-store' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) return;
        const select = document.getElementById('outletSelect');
        const current = select.value;
        select.innerHTML = '<option value="">All Outlets</option>';
        for (const outlet of data.outlets || []) {
          const opt = document.createElement('option');
          opt.value = outlet.outletId;
          opt.textContent = outlet.label || outlet.code || outlet.outletId;
          select.appendChild(opt);
        }
        select.value = current;
      } catch { }
    }

    async function loadSnapshotHealth() {
      const pill = document.getElementById('snapshotPill');
      try {
        const res = await apiFetch('/admin/bi/snapshot-health', { cache: 'no-store' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Snapshot health unavailable');

        const latest = data.latest || {};
        const best = latest.outlets || latest.sales || latest.inventory || latest.customers || null;

        if (!best) {
          pill.textContent = 'No snapshots yet';
          pill.className = 'pill bad';
          return;
        }

        const ageMs = Date.now() - new Date(best).getTime();
        const daysOld = Math.floor(ageMs / (24 * 60 * 60 * 1000));

        pill.textContent = daysOld <= 1 ? `Snapshots current (as of ${best})` : `Snapshots stale (${best})`;
        pill.className = daysOld <= 1 ? 'pill' : (daysOld <= 3 ? 'pill warn' : 'pill bad');
      } catch (e) {
        pill.textContent = 'Snapshot health error';
        pill.className = 'pill bad';
      }
    }

    async function loadCompliance() {
      const pill = document.getElementById('compliancePill');
      if (!pill) return;
      try {
        const outletId = document.getElementById('outletSelect')?.value || '';
        const params = new URLSearchParams({ minutes: '240', limit: '200' });
        if (outletId) params.set('outletId', outletId);
        const res = await apiFetch(`/admin/compliance/summary?${params.toString()}`, { cache: 'no-store' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || 'Compliance unavailable');

        const missing = Number(data.missingCount || 0);
        pill.textContent = missing > 0 ? `Compliance: ${missing} missing scan(s)` : 'Compliance: OK';
        pill.className = missing > 0 ? 'pill bad' : 'pill';
      } catch (e) {
        pill.textContent = 'Compliance: error';
        pill.className = 'pill bad';
      }
    }

    function buildParams(extra = {}) {
      const days = document.getElementById('daysSelect').value;
      const outletId = document.getElementById('outletSelect').value;
      const params = new URLSearchParams({ days });
      if (outletId) params.set('outletId', outletId);
      for (const [k, v] of Object.entries(extra)) {
        if (v !== undefined && v !== null && String(v).length) params.set(k, String(v));
      }
      return params.toString();
    }

    async function loadSummary() {
      const days = document.getElementById('daysSelect').value;
      const outletId = document.getElementById('outletSelect').value || null;

      const res = await apiFetch(`/admin/bi/summary?${buildParams()}`, { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.message || 'Summary unavailable');

      const totals = data.totals || {};
      const range = data.range || {};

      document.getElementById('kpiRevenue').textContent = fmtMoney(totals.totalRevenue);
      document.getElementById('kpiTransactions').textContent = fmtInt(totals.totalTransactions);
      document.getElementById('kpiAvgTicket').textContent = fmtMoney(totals.avgTransactionValue);
      document.getElementById('kpiItemsSold').textContent = fmtInt(totals.itemsSold);
      document.getElementById('kpiCustomers').textContent = totals.uniqueCustomers === null ? '—' : fmtInt(totals.uniqueCustomers);

      const scope = outletId ? 'Outlet' : 'All outlets';
      const windowText = range.start && range.end ? `${range.start} → ${range.end}` : `Last ${days} days`;
      document.getElementById('kpiRevenueMeta').textContent = `${scope} • ${windowText}`;
      document.getElementById('kpiTransactionsMeta').textContent = `${scope} • ${windowText}`;
      document.getElementById('kpiAvgTicketMeta').textContent = `${scope} • ${windowText}`;
      document.getElementById('kpiItemsSoldMeta').textContent = `${scope} • ${windowText}`;
      document.getElementById('kpiCustomersMeta').textContent = `${scope} • ${windowText}`;
    }

    async function loadTopProducts() {
      const body = document.getElementById('topProductsBody');
      const meta = document.getElementById('topProductsMeta');
      body.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;

      const res = await apiFetch(`/admin/bi/top-products?${buildParams({ limit: 10, sortBy: 'revenue' })}`, { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.message || 'Top products unavailable');

      const items = data.products || [];
      meta.textContent = items.length ? `${items.length} products • ${data.range?.start} → ${data.range?.end}` : '—';

      if (!items.length) {
        body.innerHTML = `<tr><td colspan="5" class="muted">No snapshot rows.</td></tr>`;
        return;
      }

      body.innerHTML = items.map((p) => `
        <tr>
          <td>${escapeHtml(p.productName || p.productId)}</td>
          <td>${escapeHtml(p.sku || '—')}</td>
          <td>${fmtInt(p.quantitySold)}</td>
          <td>${fmtMoney(p.revenue)}</td>
          <td>${fmtInt(p.transactionCount)}</td>
        </tr>
      `).join('');
    }

    async function loadLowStock() {
      const body = document.getElementById('lowStockBody');
      const meta = document.getElementById('lowStockMeta');
      body.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;

      const res = await apiFetch(`/admin/bi/low-stock?${buildParams({ limit: 25 })}`, { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        meta.textContent = '—';
        body.innerHTML = `<tr><td colspan="5" class="muted">${escapeHtml(data.message || 'Low stock unavailable')}</td></tr>`;
        return;
      }

      const items = data.items || [];
      meta.textContent = data.snapshotDate ? `Snapshot: ${data.snapshotDate}` : '—';

      if (!items.length) {
        body.innerHTML = `<tr><td colspan="5" class="muted">No low stock items returned.</td></tr>`;
        return;
      }

      body.innerHTML = items.map((it) => `
        <tr>
          <td>${escapeHtml(it.outletName || it.outletId || '—')}</td>
          <td>${escapeHtml(it.productName || it.productId)}</td>
          <td>${escapeHtml(it.sku || '—')}</td>
          <td>${fmtInt(it.currentAmount)}</td>
          <td>${it.reorderPoint === null || it.reorderPoint === undefined ? '—' : fmtInt(it.reorderPoint)}</td>
        </tr>
      `).join('');
    }

    async function loadTopCustomers() {
      const body = document.getElementById('topCustomersBody');
      const meta = document.getElementById('topCustomersMeta');
      body.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;

      const res = await apiFetch(`/admin/bi/top-customers?${buildParams({ limit: 10 })}`, { cache: 'no-store' });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.message || 'Top customers unavailable');

      const items = data.customers || [];
      meta.textContent = items.length ? `${items.length} customers • ${data.range?.start} → ${data.range?.end}` : '—';

      if (!items.length) {
        body.innerHTML = `<tr><td colspan="5" class="muted">No snapshot rows.</td></tr>`;
        return;
      }

      body.innerHTML = items.map((c) => `
        <tr>
          <td>${escapeHtml(c.customerName || c.customerId)}</td>
          <td>${escapeHtml(c.customerEmail || '—')}</td>
          <td>${fmtInt(c.transactionCount)}</td>
          <td>${fmtMoney(c.totalSpend)}</td>
          <td>${fmtMoney(c.avgTransactionValue)}</td>
        </tr>
      `).join('');
    }

    async function refreshAll() {
      const lastUpdated = document.getElementById('lastUpdated');
      lastUpdated.textContent = 'Refreshing…';
      try {
        await Promise.all([loadSnapshotHealth(), loadCompliance()]);
        await Promise.all([loadSummary(), loadTopProducts(), loadLowStock(), loadTopCustomers()]);
        lastUpdated.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        lastUpdated.textContent = `Error: ${e.message}`;
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', refreshAll);
    document.getElementById('daysSelect').addEventListener('change', refreshAll);
    document.getElementById('outletSelect').addEventListener('change', refreshAll);

    loadOutlets().then(refreshAll);
    setInterval(refreshAll, 60000);
  </script>
</body>

</html>
