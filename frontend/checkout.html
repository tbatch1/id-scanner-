<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>THC Club | Age Verified Checkout</title>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-barcode-reader-bundle@10.4.3100/dist/dbr.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-code-parser@2.4.32/dist/dcp.js"></script>
    <style>
        :root {
            color-scheme: dark;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #111;
            color: #f5f5f5;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .system-banner {
            padding: 12px 32px;
            font-size: 14px;
            background: #1f2b3f;
            border-bottom: 1px solid #0d6efd;
            color: #d3e6ff;
        }

        .system-banner.info {
            background: #1f2b3f;
            border-color: #4f8cff;
            color: #d3e6ff;
        }

        .system-banner.warn {
            background: #3f2a11;
            border-color: #ff9800;
            color: #ffe0b2;
        }

        .system-banner.error {
            background: #3f1417;
            border-color: #ff4d4f;
            color: #ffc7c9;
        }

        .system-banner.clickable {
            cursor: pointer;
            text-decoration: underline;
        }

        header {
            background: #181818;
            padding: 18px 32px;
            border-bottom: 2px solid #0d6efd;
        }

        header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 15px;
            color: #a5a5a5;
        }

        .meta span {
            white-space: nowrap;
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        aside {
            width: 340px;
            background: #161616;
            border-right: 1px solid #222;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .sale-summary h2 {
            font-size: 18px;
            margin-bottom: 12px;
        }

        .sale-lines {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .sale-line {
            background: #1f1f1f;
            border-radius: 8px;
            padding: 12px;
        }

        .sale-line-title {
            font-weight: 600;
            font-size: 15px;
        }

        .sale-line-meta {
            font-size: 13px;
            color: #b5b5b5;
            margin-top: 4px;
        }

        .status-card {
            background: #1f1f1f;
            border-radius: 10px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .status-helper {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            color: #c9c9c9;
        }

        .status-helper ul {
            margin: 8px 0 0;
            padding-left: 18px;
            line-height: 1.5;
        }

        .status-line {
            font-size: 13px;
            color: #cfd8e3;
            margin-top: 6px;
        }

        .status-line strong {
            color: #f5f5f5;
        }

        .status-actions {
            display: flex;
            gap: 8px;
        }

        .status-actions .tertiary {
            background: rgba(255, 255, 255, 0.05);
            color: #d9d9d9;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
        }

        .status-actions .tertiary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .help-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .help-modal.show {
            display: flex;
        }

        .help-modal .help-content {
            background: #161616;
            border-radius: 12px;
            max-width: 420px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45);
            color: #f3f3f3;
        }

        .help-modal .help-content h3 {
            margin-bottom: 12px;
        }

        .help-modal .help-content ul {
            padding-left: 20px;
            margin: 0 0 16px;
            line-height: 1.6;
        }

        .help-modal .close-help {
            background: #0d6efd;
            border: none;
            color: #fff;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }

        .manual-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .manual-modal.show {
            display: flex;
        }

        .manual-content {
            background: #161616;
            border-radius: 12px;
            padding: 24px;
            width: min(440px, 92vw);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.45);
        }

        .manual-content h3 {
            margin-bottom: 16px;
        }

        .manual-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
            margin-bottom: 12px;
        }

        .manual-field input,
        .manual-field textarea {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px;
            color: #f5f5f5;
        }

        .manual-field input:focus,
        .manual-field textarea:focus {
            outline: 1px solid rgba(13, 110, 253, 0.6);
        }

        .manual-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 8px;
        }

        .manual-actions .secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #d9d9d9;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 6px;
            padding: 8px 14px;
        }

        .manual-actions .secondary:hover {
            background: rgba(255, 255, 255, 0.12);
        }

        .manual-actions .primary {
            padding: 8px 16px;
        }

        .status-pill {
            align-self: flex-start;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 13px;
            background: #343434;
            color: #d8d8d8;
        }

        .status-pill.approved {
            background: rgba(13, 110, 253, 0.2);
            color: #74b4ff;
        }

        .status-pill.flagged {
            background: rgba(220, 53, 69, 0.24);
            color: #ff8a8a;
        }

        .status-message {
            font-size: 15px;
            line-height: 1.4;
            color: #c9c9c9;
        }

        .compliance-card {
            background: #1f1f1f;
            border-radius: 10px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .compliance-card[data-state='unavailable'] .metric-value,
        .compliance-card[data-state='unavailable'] .metric-label {
            opacity: 0.45;
        }

        .compliance-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .compliance-header h2 {
            font-size: 17px;
            margin: 0;
        }

        .compliance-refresh {
            border: 1px solid #343434;
            border-radius: 6px;
            background: transparent;
            color: #bdbdbd;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .compliance-refresh:hover {
            background: #232323;
            color: #e4e4e4;
        }

        .compliance-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .compliance-metric {
            background: #262626;
            border-radius: 8px;
            padding: 12px;
        }

        .metric-label {
            font-size: 12px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #8f8f8f;
            margin-bottom: 6px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #f5f5f5;
        }

        .metric-sub {
            margin-top: 4px;
            font-size: 12px;
            color: #9aa8bd;
        }

        .compliance-footer {
            font-size: 12px;
            color: #9a9a9a;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .compliance-footer span {
            display: block;
        }

        .actions {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        button {
            border: none;
            border-radius: 8px;
            padding: 14px 18px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease, opacity 0.1s ease;
        }

        button.primary {
            background: #0d6efd;
            color: white;
        }

        button.secondary {
            background: #2b2b2b;
            color: #f5f5f5;
        }

        button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        button:not(:disabled):active {
            transform: scale(0.98);
        }

        section.scanner {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: black;
        }

        #scanner-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #camera-view-container {
            width: 100%;
            height: 100%;
        }

        #instruction {
            position: absolute;
            top: 32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 15, 0.88);
            padding: 16px 28px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 10;
        }

        #result {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 24px;
            padding: 20px;
            padding-bottom: 100px;
            text-align: center;
            z-index: 100;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #result.show {
            display: flex;
        }

        .result-card {
            background: #1b1b1b;
            border-radius: 16px;
            padding: 32px 42px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.4);
            max-width: 540px;
            width: 100%;
            margin: auto 0;
        }

        .age-status {
            font-size: 56px;
            font-weight: 700;
            margin-bottom: 20px;
            border-radius: 12px;
            padding: 18px;
        }

        .age-status.approved {
            background: #198754;
            color: #e8fff1;
        }

        .age-status.denied {
            background: #dc3545;
            color: #ffecec;
        }

        .info {
            font-size: 20px;
            line-height: 1.5;
            margin: 16px 0;
        }

        .info-label {
            color: #a5a5a5;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1.4px;
        }

        .toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 53, 69, 0.9);
            color: white;
            padding: 14px 22px;
            border-radius: 10px;
            font-size: 15px;
            display: none;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
            z-index: 200;
        }

        .toast.show {
            display: inline-flex;
        }

        @media (max-width: 980px) {
            body {
                overflow-y: auto;
            }

            main {
                flex-direction: column;
            }

            aside {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #222;
            }

            section.scanner {
                min-height: 420px;
            }
        }
    </style>
</head>
<body>
    <div id="system-banner" class="system-banner info" hidden></div>
    <header>
        <h1>Age Verified Checkout</h1>
        <div class="meta">
            <span id="sale-label">Sale: --</span>
            <span id="total-label">Total: --</span>
            <span id="location-label">Location: --</span>
            <span id="register-label" hidden>Register: --</span>
            <span id="payment-label">Payment: --</span>
            <span id="phone-label" hidden>Phone: --</span>
            <span id="clerk-label">Clerk: --</span>
            <span id="status-label">Status: Awaiting scan</span>
        </div>
    </header>
    <main>
        <aside>
            <section class="sale-summary">
                <h2>Current Sale</h2>
                <div class="sale-lines" id="sale-lines"></div>
            </section>
            <section class="status-card">
                <span class="status-pill" id="verification-pill">Not verified</span>
                <p class="status-message" id="status-message">
                    Hold the ID 4-6 inches from the camera. Keep barcodes or passport MRZ lines flat and avoid glare.
                </p>
                <div class="status-helper" id="status-helper">
                    <strong>Quick Tips</strong>
                    <ul>
                        <li>Aim for bright, even light &mdash; no shadows.</li>
                        <li>Press and hold passports so both MRZ lines are visible.</li>
                        <li>If the scan fails twice, tap Help for manual steps.</li>
                    </ul>
                </div>
                <div class="status-actions">
                    <button type="button" id="help-button" class="tertiary">Help</button>
                    <button type="button" id="manual-entry-button" class="tertiary">Manual Entry</button>
                </div>
            </section>
            <section class="status-card" id="lightspeed-status-card">
                <h2>Lightspeed Status</h2>
                <div class="status-helper">
                    <div class="status-line"><strong>Mode:</strong> <span id="ls-mode">--</span></div>
                    <div class="status-line"><strong>Writes:</strong> <span id="ls-writes">--</span></div>
                    <div class="status-line"><strong>Token:</strong> <span id="ls-token">--</span></div>
                    <div class="status-line"><strong>Outlet:</strong> <span id="ls-outlet">--</span></div>
                </div>
                <button type="button" class="tertiary" id="ls-refresh">Refresh Status</button>
            </section>
            <div class="actions">
                <button class="primary" id="complete-sale" disabled>Complete Sale</button>
                <button class="secondary" id="restart-scan">Restart Scan</button>
            </div>
            <section class="compliance-card" id="compliance-card" data-state="loading" hidden>
                <div class="compliance-header">
                    <h2>Compliance Snapshot</h2>
                    <button class="compliance-refresh" id="refresh-compliance" type="button">Refresh</button>
                </div>
                <div class="compliance-grid">
                    <div class="compliance-metric">
                        <div class="metric-label">Verifications</div>
                        <div class="metric-value" id="compliance-total">--</div>
                    </div>
                    <div class="compliance-metric">
                        <div class="metric-label">Approved</div>
                        <div class="metric-value" id="compliance-approved">--</div>
                    </div>
                    <div class="compliance-metric">
                        <div class="metric-label">Rejected</div>
                        <div class="metric-value" id="compliance-rejected">--</div>
                    </div>
                    <div class="compliance-metric">
                        <div class="metric-label">Last 30 Days</div>
                        <div class="metric-value" id="compliance-range">--</div>
                    </div>
                    <div class="compliance-metric">
                        <div class="metric-label">Top Location</div>
                        <div class="metric-value" id="compliance-top-location">--</div>
                        <div class="metric-sub" id="compliance-top-count">--</div>
                    </div>
                </div>
                <div class="compliance-footer">
                    <span id="compliance-message">Loading compliance data...</span>
                    <span id="compliance-reason"></span>
                </div>
            </section>
        </aside>
        <section class="scanner">
            <div id="scanner-container">
                <div id="camera-view-container"></div>
                <div id="instruction">Aim at the barcode on the driver's license</div>
                <div id="result">
                    <div class="result-card">
                        <div id="age-status" class="age-status">Scanning...</div>
                        <div class="info">
                            <div class="info-label">Customer</div>
                            <div id="name">--</div>
                        </div>
                        <div class="info">
                            <div class="info-label">Date of Birth</div>
                            <div id="dob">--</div>
                        </div>
                        <div class="info">
                            <div class="info-label">Calculated Age</div>
                            <div id="age">--</div>
                        </div>
                        <button class="secondary" id="scan-again" type="button">Scan Another ID</button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <div class="help-modal" id="help-modal">
        <div class="help-content">
            <h3>Manual Review Steps</h3>
            <ul>
                <li>Verify the photo ID manually and confirm the age before proceeding.</li>
                <li>If the document is damaged, switch to manual entry and capture the details in Lightspeed.</li>
                <li>Contact a manager for overrides or banned customer escalation.</li>
            </ul>
            <button class="close-help" id="close-help" type="button">Got it</button>
        </div>
    </div>
    <div class="manual-modal" id="manual-modal">
        <div class="manual-content">
            <h3>Manager Override</h3>
            <form id="manual-form">
                <label class="manual-field">
                    Manager ID (optional)
                    <input id="manual-manager" type="text" placeholder="Manager name or ID" />
                </label>
                <label class="manual-field">
                    Manager PIN
                    <input id="manual-pin" type="password" placeholder="Required" required />
                </label>
                <label class="manual-field">
                    Reason / Notes
                    <textarea id="manual-note" rows="3" placeholder="Why are we overriding?"></textarea>
                </label>
                <div class="manual-actions">
                    <button type="button" id="manual-cancel" class="secondary">Cancel</button>
                    <button type="submit" class="primary">Submit Override</button>
                </div>
            </form>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <script type="module">
    import { state, setSaleContext, setLatestVerification, clearLatestVerification, markScannerInitialized, setSaleLocation } from './js/state.js';
    import { calculateAge, parseLicenseData as parseLicenseCore, parseMrz } from './js/utils.js';

    (function () {
        'use strict';

        // Initialize Dynamsoft license
        Dynamsoft.License.LicenseManager.initLicense("DLS2eyJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSJ9");

        // Preload modules
        Dynamsoft.Core.CoreModule.loadWasm(["DBR", "DCP"]);
        Dynamsoft.DCP.CodeParserModule.loadSpec("AAMVA_DL_ID");
        Dynamsoft.DCP.CodeParserModule.loadSpec("AAMVA_DL_ID_WITH_MAG_STRIPE");
        Dynamsoft.DCP.CodeParserModule.loadSpec("SOUTH_AFRICA_DL");
        Dynamsoft.DCP.CodeParserModule.loadSpec("ICAO_MRZ");
        Dynamsoft.DCP.CodeParserModule.loadSpec("MRZ_TD1");
        Dynamsoft.DCP.CodeParserModule.loadSpec("MRZ_TD2");

        // URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const saleId = urlParams.get('saleId') || 'SALE-1001';
        const clerkId = urlParams.get('clerkId') || urlParams.get('employeeID') || 'demo-clerk';
        const paymentType = (urlParams.get('type') || 'cash').toLowerCase(); // 'cash' or 'card'
        let customerPhone = urlParams.get('phone') || urlParams.get('customerPhone') || null;
        if (customerPhone) {
            customerPhone = customerPhone.trim();
            if (!customerPhone.length) {
                customerPhone = null;
            }
        }
        let locationHint = urlParams.get('locationId') || urlParams.get('outletId') || urlParams.get('outlet');
        if (locationHint) {
            locationHint = locationHint.trim();
            if (!locationHint.length) {
                locationHint = null;
            }
        }
        const autoCloseParam = urlParams.get('autoClose') || urlParams.get('autoclose');
        let autoClose = Boolean(paymentType);
        if (autoCloseParam) {
            autoClose = !['false', '0', 'no'].includes(autoCloseParam.toLowerCase());
        }
        const apiOverride = urlParams.get('api');
        const defaultApiBase = window.location.protocol === 'file:'
            ? 'http://localhost:4000/api'
            : `${window.location.origin}/api`;
        const API_BASE = apiOverride || defaultApiBase;
        const apiKeyParam = urlParams.get('apiKey');
        const storedApiKey = window.sessionStorage.getItem('idscanner_apiKey');
        const API_KEY = apiKeyParam || storedApiKey || null;

        if (apiKeyParam) {
            window.sessionStorage.setItem('idscanner_apiKey', apiKeyParam);
        }

        setSaleContext({
            saleId,
            clerkId,
            paymentType,
            apiBase: API_BASE,
            apiKey: API_KEY,
            locationId: locationHint,
            customerPhone,
            autoClose
        });
        if (locationHint) {
            setSaleLocation({ locationId: locationHint });
            updateLocationIndicator();
        }
        updatePaymentIndicator();
        updatePhoneIndicator();

        refreshHealthStatus();
        healthInterval = setInterval(refreshHealthStatus, 60000);

        function buildHeaders(additional = {}) {
            const headers = { ...additional };
            if (state.apiKey) {
                headers['X-API-Key'] = state.apiKey;
            }
            if (state.locationId) {
                headers['X-Location-Id'] = state.locationId;
            }
            return headers;
        }

        function buildApiUrl(path) {
            const base = (state.apiBase || API_BASE || '').replace(/\/+$/, '');
            const normalizedPath = (path || '').replace(/^\/+/, '');
            return normalizedPath ? `${base}/${normalizedPath}` : base;
        }

        function notifyIntegration(eventName, payload = {}) {
            const message = {
                source: 'id-scanner',
                event: eventName,
                saleId: state.saleId,
                clerkId: state.clerkId,
                paymentType: state.paymentType,
                autoClose: state.autoClose,
                locationId: state.locationId,
                ...payload
            };

            if (window.opener && typeof window.opener.postMessage === 'function') {
                window.opener.postMessage(message, '*');
            }

            if (window.parent && window.parent !== window && typeof window.parent.postMessage === 'function') {
                window.parent.postMessage(message, '*');
            }
        }

        async function logFrontendEvent(level, message, meta = {}) {
            const payload = {
                timestamp: new Date().toISOString(),
                level,
                message,
                meta: {
                    saleId: state.saleId,
                    clerkId: state.clerkId,
                    locationId: state.locationId,
                    outletLabel: state.outlet?.label || state.outlet?.code || null,
                    ...meta
                }
            };

            try {
                await fetch(buildApiUrl('logs'), {
                    method: 'POST',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify(payload),
                    keepalive: true
                });
            } catch (error) {
                console.warn('Unable to send frontend log:', error);
            }
        }
        logFrontendEvent('info', 'Checkout page loaded', {
            paymentType,
            customerPhone
        });
        notifyIntegration('loaded', {
            phone: customerPhone || null
        });

        // UI Elements
        const ui = {
            saleLabel: document.getElementById('sale-label'),
            totalLabel: document.getElementById('total-label'),
            locationLabel: document.getElementById('location-label'),
            registerLabel: document.getElementById('register-label'),
            paymentLabel: document.getElementById('payment-label'),
            phoneLabel: document.getElementById('phone-label'),
            clerkLabel: document.getElementById('clerk-label'),
            statusLabel: document.getElementById('status-label'),
            saleLinesContainer: document.getElementById('sale-lines'),
            verificationPill: document.getElementById('verification-pill'),
            statusMessage: document.getElementById('status-message'),
            completeSaleBtn: document.getElementById('complete-sale'),
            restartScanBtn: document.getElementById('restart-scan'),
            scanAgainBtn: document.getElementById('scan-again'),
            resultOverlay: document.getElementById('result'),
            ageStatusDiv: document.getElementById('age-status'),
            nameDiv: document.getElementById('name'),
            dobDiv: document.getElementById('dob'),
            ageDiv: document.getElementById('age'),
            toast: document.getElementById('toast'),
            cameraViewContainer: document.getElementById('camera-view-container'),
            complianceCard: document.getElementById('compliance-card'),
            complianceTotal: document.getElementById('compliance-total'),
            complianceApproved: document.getElementById('compliance-approved'),
            complianceRejected: document.getElementById('compliance-rejected'),
            complianceRange: document.getElementById('compliance-range'),
            complianceTopLocation: document.getElementById('compliance-top-location'),
            complianceTopCount: document.getElementById('compliance-top-count'),
            complianceMessage: document.getElementById('compliance-message'),
            complianceReason: document.getElementById('compliance-reason'),
            refreshComplianceBtn: document.getElementById('refresh-compliance'),
            helpButton: document.getElementById('help-button'),
            manualEntryButton: document.getElementById('manual-entry-button'),
            helpModal: document.getElementById('help-modal'),
            closeHelpButton: document.getElementById('close-help'),
            manualModal: document.getElementById('manual-modal'),
            manualForm: document.getElementById('manual-form'),
            manualPinInput: document.getElementById('manual-pin'),
            manualNoteInput: document.getElementById('manual-note'),
            manualManagerInput: document.getElementById('manual-manager'),
            manualCancelButton: document.getElementById('manual-cancel'),
            systemBanner: document.getElementById('system-banner'),
            lsMode: document.getElementById('ls-mode'),
            lsWrites: document.getElementById('ls-writes'),
            lsToken: document.getElementById('ls-token'),
            lsOutlet: document.getElementById('ls-outlet'),
            lsRefresh: document.getElementById('ls-refresh')
        };

        if (ui.systemBanner) {
            ui.systemBanner.addEventListener('click', () => {
                const action = ui.systemBanner.dataset.action;
                if (action === 'oauth') {
                    const redirectTarget = encodeURIComponent(window.location.href);
                    const loginUrl = `${buildApiUrl('/auth/login')}?redirect=${redirectTarget}`;
                    window.open(loginUrl, '_blank', 'noopener');
                }
            });
        }

        if (ui.lsRefresh) {
            ui.lsRefresh.addEventListener('click', () => {
                refreshHealthStatus(true);
            });
        }

        // Global state
        let cvRouter = null;
        let cameraEnhancer = null;
        let parser = null;
        let healthInterval = null;

        function showToast(message, variant = 'error') {
            ui.toast.textContent = message;
            ui.toast.style.background = variant === 'error'
                ? 'rgba(220, 53, 69, 0.9)'
                : 'rgba(13, 110, 253, 0.9)';
            ui.toast.classList.add('show');
            setTimeout(() => ui.toast.classList.remove('show'), 3200);
        }

        function setSystemBanner(message, level = 'info', action = null) {
            if (!ui.systemBanner) return;
            const banner = ui.systemBanner;
            banner.classList.remove('info', 'warn', 'error', 'clickable');
            if (!message) {
                banner.hidden = true;
                banner.textContent = '';
                banner.dataset.action = '';
                return;
            }

            const normalizedLevel = ['error', 'warn', 'info'].includes(level) ? level : 'info';
            banner.hidden = false;
            banner.textContent = message;
            banner.classList.add(normalizedLevel);

            if (action) {
                banner.dataset.action = action;
                banner.classList.add('clickable');
            } else {
                banner.dataset.action = '';
            }
        }

        async function refreshHealthStatus(forceCardUpdate = false) {
            try {
                const response = await fetch(buildApiUrl('/health'), {
                    headers: buildHeaders()
                });

                if (!response.ok) {
                    throw new Error(`Healthcheck failed (${response.status})`);
                }

                const payload = await response.json();
                const alerts = [];
                let level = 'info';
                let action = null;

                if (payload.database === 'error') {
                    alerts.push('Compliance database offline');
                    level = 'error';
                } else if (payload.database === 'not_configured') {
                    alerts.push('Compliance database not configured');
                    level = level === 'error' ? 'error' : 'warn';
                }

                const lightspeed = payload.lightspeed || {};

                if (ui.lsMode) {
                    ui.lsMode.textContent = (lightspeed.mode || 'unknown').toUpperCase();
                }
                if (ui.lsWrites) {
                    ui.lsWrites.textContent = lightspeed.writesEnabled ? 'ENABLED' : 'READ-ONLY';
                }
                if (ui.lsToken) {
                    let tokenLabel = 'n/a';
                    if (lightspeed.hasRefreshToken === false) {
                        tokenLabel = 'MISSING';
                    } else if (lightspeed.accessTokenExpiresAt) {
                        const expires = new Date(lightspeed.accessTokenExpiresAt);
                        const delta = expires.getTime() - Date.now();
                        if (Number.isFinite(delta)) {
                            const minutes = Math.round(delta / 60000);
                            if (minutes < 0) {
                                tokenLabel = 'EXPIRED';
                            } else if (minutes < 5) {
                                tokenLabel = `in ${minutes} min`;
                            } else {
                                const hours = Math.round(minutes / 60);
                                tokenLabel = hours >= 1 ? `in ${hours} hr` : `in ${minutes} min`;
                            }
                        } else {
                            tokenLabel = expires.toISOString();
                        }
                    }
                    ui.lsToken.textContent = tokenLabel;
                }
                if (ui.lsOutlet) {
                    const outletDisplay =
                        (state.outlet && (state.outlet.label || state.outlet.code)) ||
                        lightspeed.defaultOutletId ||
                        state.locationId ||
                        '--';
                    ui.lsOutlet.textContent = outletDisplay;
                }
                if (lightspeed.mode === 'live') {
                    if (lightspeed.status === 'needs_login') {
                        alerts.push('Lightspeed login required. Tap to reauthorize.');
                        level = level === 'error' ? 'error' : 'warn';
                        action = action || 'oauth';
                    } else if (lightspeed.status === 'needs_configuration') {
                        alerts.push('Lightspeed configuration incomplete.');
                        level = level === 'error' ? 'error' : 'warn';
                    } else if (lightspeed.status === 'expiring') {
                        alerts.push('Lightspeed token expires soon. Reauthorize.');
                        level = level === 'error' ? 'error' : 'warn';
                        action = action || 'oauth';
                    }
                } else if (lightspeed.mode === 'mock') {
                    alerts.push('Running against mock Lightspeed data.');
                }

                if (!alerts.length) {
                    setSystemBanner('');
                } else {
                    setSystemBanner(alerts.join(' ï¿½ '), level, action);
                }
            } catch (error) {
                setSystemBanner('Unable to reach backend. Check network connection.', 'error');
            }
        }

        function updateLocationIndicator() {
            if (ui.locationLabel) {
                const outlet = state.outlet || {};
                const fallback = state.locationId || '--';
                const label = outlet.label || outlet.code || fallback || '--';
                ui.locationLabel.textContent = `Location: ${label}`;
            }

            if (ui.registerLabel) {
                if (state.registerId) {
                    ui.registerLabel.hidden = false;
                    ui.registerLabel.textContent = `Register: ${state.registerId}`;
                } else {
                    ui.registerLabel.hidden = true;
                }
            }
        }

        function setVerificationState(state, message) {
            ui.verificationPill.textContent = state;
            ui.verificationPill.classList.remove('approved', 'flagged');
            ui.statusMessage.textContent = message;

            if (state === 'Approved') {
                ui.verificationPill.classList.add('approved');
            } else if (state === 'Flagged') {
                ui.verificationPill.classList.add('flagged');
            }
        }

        function formatPhone(phone) {
            if (!phone) return '';
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 10) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
            }
            if (digits.length === 11 && digits.startsWith('1')) {
                return `+1 (${digits.slice(1, 4)}) ${digits.slice(4, 7)}-${digits.slice(7)}`;
            }
            return phone;
        }

        function updatePaymentIndicator() {
            if (!ui.paymentLabel) return;
            const label = state.paymentType ? state.paymentType.toUpperCase() : '--';
            ui.paymentLabel.textContent = `Payment: ${label}`;
        }

        function updatePhoneIndicator() {
            if (!ui.phoneLabel) return;
            if (state.customerPhone) {
                ui.phoneLabel.hidden = false;
                ui.phoneLabel.textContent = `Phone: ${formatPhone(state.customerPhone)}`;
            } else {
                ui.phoneLabel.hidden = true;
            }
        }

        function renderSaleLines(sale) {
            ui.saleLinesContainer.innerHTML = '';
            sale.items.forEach((line) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'sale-line';
                wrapper.innerHTML = `
                    <div class="sale-line-title">${line.description}</div>
                    <div class="sale-line-meta">Qty ${line.quantity} | ${sale.currency || 'USD'} ${line.price.toFixed(2)}</div>
                `;
                ui.saleLinesContainer.appendChild(wrapper);
            });
        }

        function parseLicenseData(parsedInfo) {
            const base = parseLicenseCore(parsedInfo) || {};
            const normalized = {
                firstName: base.firstName || '',
                lastName: base.lastName || '',
                middleName: base.middleName || '',
                dob: base.dob || '',
                licenseNumber: base.licenseNumber || base.documentNumber || '',
                documentNumber: base.documentNumber || base.licenseNumber || '',
                documentType: base.documentType || 'drivers_license',
                issuingCountry: base.issuingCountry || '',
                nationality: base.nationality || base.issuingCountry || '',
                documentExpiry: base.documentExpiry || '',
                sex: base.sex || '',
                source: base.source || 'pdf417'
            };

            normalized.documentNumber = normalized.documentNumber ? normalized.documentNumber.replace(/\s+/g, '').toUpperCase() : '';
            if (normalized.documentNumber && !normalized.licenseNumber) {
                normalized.licenseNumber = normalized.documentNumber;
            }
            normalized.issuingCountry = normalized.issuingCountry ? normalized.issuingCountry.trim().toUpperCase() : '';
            normalized.nationality = normalized.nationality ? normalized.nationality.trim().toUpperCase() : normalized.issuingCountry;
            normalized.sex = normalized.sex ? normalized.sex.trim().toUpperCase() : '';
            normalized.documentExpiry = normalized.documentExpiry || '';

            logFrontendEvent('debug', 'Parsed PDF417 payload', {
                documentType: normalized.documentType,
                issuingCountry: normalized.issuingCountry || null,
                hasDob: Boolean(normalized.dob),
                hasExpiry: Boolean(normalized.documentExpiry)
            });

            return normalized;
        }

        async function loadSale() {
            ui.saleLabel.textContent = `Sale: ${saleId}`;
            ui.clerkLabel.textContent = `Clerk: ${clerkId}`;
            try {
                const response = await fetch(`${API_BASE}/sales/${saleId}`, {
                    headers: buildHeaders()
                });
                if (!response.ok) throw new Error(`Unable to load sale (${response.status})`);

                const payload = await response.json();
                const sale = payload.data;

                // Use employee name from Lightspeed if available
                if (sale.employeeName) {
                    ui.clerkLabel.textContent = `Clerk: ${sale.employeeName}`;
                }

                setSaleLocation({
                    locationId: sale.locationId || sale.outletId || state.locationId || null,
                    outlet: sale.outlet || state.outlet || null,
                    registerId: sale.registerId || state.registerId || null
                });
                updateLocationIndicator();
                if (!state.customerPhone) {
                    const salePhone =
                        sale.customer?.phone ||
                        sale.customer?.phoneNumber ||
                        sale.customer?.phone_number ||
                        sale.customer?.mobilePhone ||
                        null;
                    if (salePhone) {
                        state.customerPhone = salePhone;
                        updatePhoneIndicator();
                    }
                }

                ui.totalLabel.textContent = `Total: ${sale.currency || 'USD'} ${sale.total.toFixed(2)}`;
                updatePaymentIndicator();
                renderSaleLines(sale);

                if (sale.verification && !sale.verificationExpired) {
                    setLatestVerification(sale.verification);
                    setVerificationState('Approved', 'Existing verification found. Complete the sale or rescan to refresh.');
                    ui.statusLabel.textContent = 'Status: Verified';
                    ui.completeSaleBtn.disabled = false;
                } else if (sale.verification && sale.verificationExpired) {
                    setLatestVerification(sale.verification);
                    setVerificationState('Flagged', 'Previous verification expired. Rescan before completing the sale.');
                    ui.statusLabel.textContent = 'Status: Verification expired';
                    ui.completeSaleBtn.disabled = true;
                } else {
                    clearLatestVerification();
                    setVerificationState('Not verified', 'Scan the government ID to proceed with checkout.');
                    ui.statusLabel.textContent = 'Status: Awaiting scan';
                    ui.completeSaleBtn.disabled = true;
                }

                updateManualEntryAvailability();
                refreshHealthStatus();
            } catch (error) {
                showToast(error.message);
                setVerificationState('Unavailable', 'Sale data could not be loaded. Retry or contact support.');
                logFrontendEvent('error', 'Sale load failed', {
                    saleId,
                    error: error.message
                });
                clearLatestVerification();
                updateManualEntryAvailability();
                refreshHealthStatus();
                updateLocationIndicator();
            }
        }

        function setComplianceState(state, message, reason) {
            if (!ui.complianceCard) return;

            ui.complianceCard.hidden = false;
            ui.complianceCard.dataset.state = state;

            if (message) {
                ui.complianceMessage.textContent = message;
            }

            if (typeof reason === 'string') {
                ui.complianceReason.textContent = reason;
            }
        }

        async function loadComplianceSnapshot() {
            if (!ui.complianceCard) return;

            ui.complianceCard.hidden = false;
            ui.complianceCard.dataset.state = 'loading';
            ui.complianceMessage.textContent = 'Loading compliance data...';
            ui.complianceReason.textContent = '';
            if (ui.complianceTopLocation) {
                ui.complianceTopLocation.textContent = '--';
            }
            if (ui.complianceTopCount) {
                ui.complianceTopCount.textContent = 'Loading...';
            }

            try {
                const response = await fetch(`${API_BASE}/reports/compliance?days=30&limit=5`, {
                    cache: 'no-store',
                    headers: buildHeaders()
                });

                if (response.status === 503) {
                    setComplianceState(
                        'unavailable',
                        'Compliance tracking disabled. Configure DATABASE_URL to enable storage.',
                        ''
                    );
                    if (ui.complianceTopLocation) ui.complianceTopLocation.textContent = '--';
                    if (ui.complianceTopCount) ui.complianceTopCount.textContent = 'Compliance disabled';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Unexpected response ${response.status}`);
                }

                const payload = await response.json();
                const report = payload.data;

                ui.complianceCard.hidden = false;
                ui.complianceCard.dataset.state = 'ready';

                ui.complianceTotal.textContent = report.summary.totalVerifications.toString();
                ui.complianceApproved.textContent = report.summary.approved.toString();
                ui.complianceRejected.textContent = report.summary.rejected.toString();
                ui.complianceRange.textContent = report.summary.withinRange.toString();
                ui.complianceMessage.textContent = 'Tracking last 30 days';

                const topReason = report.rejectionReasons[0];
                ui.complianceReason.textContent = topReason
                    ? `Top rejection: ${topReason.reason} (${topReason.count})`
                    : 'No rejections recorded';

                const locationTotals = {};
                const locationLabels = {};

                (report.recentActivity || []).forEach((entry) => {
                    if (!entry || !entry.locationId) {
                        return;
                    }
                    const label =
                        (entry.outlet && (entry.outlet.label || entry.outlet.code)) ||
                        entry.locationId;
                    if (!locationLabels[entry.locationId]) {
                        locationLabels[entry.locationId] = label;
                    }
                });

                (report.dailyStats || []).forEach((stat) => {
                    const id = stat.locationId || 'unknown';
                    locationTotals[id] = (locationTotals[id] || 0) + stat.totalVerifications;
                    if (!locationLabels[id]) {
                        locationLabels[id] =
                            (stat.outlet && (stat.outlet.label || stat.outlet.code)) ||
                            (id === 'unknown' ? 'Unmapped location' : id);
                    }
                });

                let topLocationId = null;
                let topLocationTotal = 0;
                Object.entries(locationTotals).forEach(([id, total]) => {
                    if (total > topLocationTotal) {
                        topLocationId = id;
                        topLocationTotal = total;
                    }
                });

                if (topLocationId) {
                    const label = locationLabels[topLocationId] || topLocationId;
                    ui.complianceTopLocation.textContent = label;
                    ui.complianceTopCount.textContent = `${topLocationTotal} verifications`;
                } else if (report.summary.totalVerifications > 0 && report.recentActivity?.length) {
                    const latest = report.recentActivity[0];
                    const label =
                        (latest.outlet && (latest.outlet.label || latest.outlet.code)) ||
                        latest.locationId ||
                        'Unmapped location';
                    ui.complianceTopLocation.textContent = label;
                    ui.complianceTopCount.textContent = 'Latest activity';
                } else {
                    ui.complianceTopLocation.textContent = '--';
                    ui.complianceTopCount.textContent = 'No location data';
                }
            } catch (error) {
                console.warn('Unable to load compliance snapshot', error);
                setComplianceState(
                    'unavailable',
                    'Compliance data unavailable. Check database connection.',
                    ''
                );
                if (ui.complianceTopLocation) ui.complianceTopLocation.textContent = '--';
                if (ui.complianceTopCount) ui.complianceTopCount.textContent = 'Unavailable';
                logFrontendEvent('warn', 'Compliance snapshot unavailable', {
                    error: error.message
                });
            }
        }

        async function submitVerification(licenseData, ageData) {
            ui.statusLabel.textContent = 'Status: Sending verification...';
            setVerificationState('Pending', 'Uploading scan result. Hold tight.');
            ui.completeSaleBtn.disabled = true;

            try {
                // TRACKING: Save to scan_sessions for manager dashboard
                // Try to get employeeName from multiple sources:
                // 1. URL parameter (from payment gateway)
                // 2. State from loaded sale (from Lightspeed API)
                // 3. Extract from UI clerk label if it was updated
                let employeeName = urlParams.get('employeeName') || null;
                if (!employeeName && ui.clerkLabel.textContent.includes('Clerk: ') && !ui.clerkLabel.textContent.includes('demo-clerk')) {
                    employeeName = ui.clerkLabel.textContent.replace('Clerk: ', '').trim();
                }

                const trackingPayload = {
                    sessionId: saleId,
                    approved: ageData.age >= 21,
                    firstName: licenseData.firstName || null,
                    lastName: licenseData.lastName || null,
                    age: ageData.age,
                    dob: ageData.iso || null,
                    documentType: licenseData.documentType || 'unknown',
                    documentNumber: licenseData.documentNumber || licenseData.licenseNumber || null,
                    nationality: licenseData.nationality || null,
                    sex: licenseData.sex || null,
                    expiry: licenseData.documentExpiry || null,
                    outletId: locationHint || state.locationId || null,
                    registerId: urlParams.get('registerId') || null,
                    employeeId: clerkId,
                    employeeName: employeeName,
                    scannedAt: new Date().toISOString()
                };

                // Save to scan_sessions (non-blocking - don't wait for response)
                fetch(`${API_BASE}/scan-sessions`, {
                    method: 'POST',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify(trackingPayload)
                }).catch(err => {
                    console.warn('Failed to save to scan_sessions:', err);
                    logFrontendEvent('warn', 'Scan session tracking failed', {
                        error: err.message
                    });
                });

                const response = await fetch(`${API_BASE}/sales/${saleId}/verify`, {
                    method: 'POST',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify({
                        clerkId,
                        scan: {
                            approved: ageData.age >= 21,
                            firstName: licenseData.firstName || null,
                            lastName: licenseData.lastName || null,
                            middleName: licenseData.middleName || null,
                            dob: ageData.iso || null,
                            age: ageData.age,
                            documentType: licenseData.documentType || 'unknown',
                            documentNumber: licenseData.documentNumber || licenseData.licenseNumber || null,
                            issuingCountry: licenseData.issuingCountry || null,
                            nationality: licenseData.nationality || null,
                            documentExpiry: licenseData.documentExpiry || null,
                            sex: licenseData.sex || null,
                            source: licenseData.source || 'pdf417'
                        }
                    })
                });

                if (!response.ok) throw new Error('Unable to record verification. Try again.');

                const payload = await response.json();
                const verification = payload.data;
                setSaleLocation({
                    locationId: verification.locationId || state.locationId || null,
                    outlet: verification.outlet || state.outlet || null,
                    registerId: verification.registerId || state.registerId || null
                });
                updateLocationIndicator();
                setLatestVerification(verification);
                updateManualEntryAvailability();
                refreshHealthStatus();
                const isBanned = Boolean(verification?.banned);
                logFrontendEvent('info', 'Verification recorded', {
                    saleId: state.saleId,
                    verificationId: verification?.verificationId || null,
                    status: verification?.status || 'unknown',
                    banned: isBanned,
                    phone: state.customerPhone
                });
                notifyIntegration('verification', {
                    verificationId: verification?.verificationId || null,
                    approved:
                        verification?.status === 'approved' ||
                        verification?.status === 'approved_override',
                    status: verification?.status || 'unknown',
                    banned: isBanned,
                    reason: verification?.bannedReason || verification?.reason || null
                });

                if (verification.status === 'approved' && !isBanned) {
                    setVerificationState('Approved', 'Verification recorded. You can complete the sale now.');
                    ui.statusLabel.textContent = 'Status: Verified';
                    ui.completeSaleBtn.disabled = false;
                } else {
                    const reasonMessage = verification.bannedReason || verification.reason || 'Verification rejected.';
                    setVerificationState('Flagged', reasonMessage);
                    ui.statusLabel.textContent = isBanned ? 'Status: Banned ID' : 'Status: Verification failed';
                    ui.completeSaleBtn.disabled = true;
                    logFrontendEvent('warn', 'Verification rejected', {
                        saleId: state.saleId,
                        verificationId: verification?.verificationId || null,
                        reason: reasonMessage
                    });
                }

                await loadComplianceSnapshot();
                return verification;
            } catch (error) {
                showToast(error.message);
                setVerificationState('Not verified', 'Scan failed to upload. Rescan or refresh.');
                ui.statusLabel.textContent = 'Status: Awaiting scan';
                clearLatestVerification();
                updateManualEntryAvailability();
                logFrontendEvent('error', 'Verification submission failed', {
                    saleId: state.saleId,
                    clerkId: state.clerkId,
                    error: error.message,
                    phone: state.customerPhone
                });
                refreshHealthStatus();
                updateLocationIndicator();
                notifyIntegration('verification_error', {
                    error: error.message
                });
                return null;
            }
        }

        async function completeSale(autoClose = false) {
            const latestVerificationResponse = await fetch(`${API_BASE}/sales/${saleId}`, {
                headers: buildHeaders()
            });
            const latestSaleData = await latestVerificationResponse.json();
            const saleInfo = latestSaleData.data || {};

            setSaleLocation({
                locationId: saleInfo.locationId || saleInfo.outletId || state.locationId || null,
                outlet: saleInfo.outlet || state.outlet || null,
                registerId: saleInfo.registerId || state.registerId || null
            });
            updateLocationIndicator();

            const verificationFromServer = saleInfo.verification;

            if (!verificationFromServer) {
                showToast('No verification on record. Scan the ID first.');
                return;
            }

            setLatestVerification(verificationFromServer);

            ui.completeSaleBtn.disabled = true;
            ui.completeSaleBtn.textContent = 'Completing...';

            try {
                logFrontendEvent('info', 'Completing sale request', {
                    saleId,
                    clerkId,
                    paymentType,
                    phone: state.customerPhone
                });

                const response = await fetch(`${API_BASE}/sales/${saleId}/complete`, {
                    method: 'POST',
                    headers: buildHeaders({ 'Content-Type': 'application/json' }),
                    body: JSON.stringify({
                        verificationId: verificationFromServer.verificationId,
                        paymentType // 'cash' or 'card' from URL
                    })
                });

                const completionPayload = await response.json().catch(() => ({}));
                if (!response.ok) {
                    throw new Error(completionPayload.message || 'Unable to complete sale. Try again.');
                }

                const completion = completionPayload.data || {};
                setSaleLocation({
                    locationId: completion.locationId || state.locationId || null,
                    outlet: completion.outlet || state.outlet || null,
                    registerId: completion.registerId || state.registerId || null
                });
                updateLocationIndicator();

                logFrontendEvent('info', 'Sale completed successfully', {
                    saleId,
                    paymentType,
                    locationId: state.locationId,
                    phone: state.customerPhone
                });
                notifyIntegration('sale_completed', {
                    verificationId: verificationFromServer.verificationId,
                    paymentType,
                    amount: completion.amount ?? sale.total ?? null,
                    locationId: state.locationId
                });
                ui.statusLabel.textContent = 'Status: Completed';
                setVerificationState('Approved', `Sale completed with ${paymentType}. Returning to Lightspeed...`);
                showToast(`Sale completed with ${paymentType}!`, 'info');

                refreshHealthStatus();
                await loadComplianceSnapshot();

                // Auto-close after 2 seconds if in auto-close mode
                if (autoClose) {
                    setTimeout(() => {
                        notifyIntegration('closing', {
                            reason: 'autoClose'
                        });
                        window.close(); // Close scanner window
                    }, 2000);
                }
            } catch (error) {
                console.error('Error completing sale:', error);
                showToast(error.message);
                logFrontendEvent('error', 'Sale completion failed', {
                    saleId,
                    paymentType,
                    error: error.message,
                    phone: state.customerPhone
                });
                refreshHealthStatus();
                updateLocationIndicator();
                notifyIntegration('sale_error', {
                    error: error.message
                });
                ui.completeSaleBtn.disabled = false;
            } finally {
                ui.completeSaleBtn.textContent = 'Complete Sale';
            }
        }

        function resetResultOverlay() {
            ui.resultOverlay.classList.remove('show');
            ui.ageStatusDiv.textContent = 'Scanning...';
            ui.ageStatusDiv.className = 'age-status';
            ui.nameDiv.textContent = '--';
            ui.dobDiv.textContent = '--';
            ui.ageDiv.textContent = '--';
            closeHelpModal();
            clearLatestVerification();
            updateManualEntryAvailability();
        }



        function updateManualEntryAvailability() {
            if (!ui.manualEntryButton) return;
            const latest = state.latestVerification;
            const eligible = latest && !['approved', 'approved_override'].includes(latest.status);
            ui.manualEntryButton.disabled = !eligible;
        }

            return {
                iso: ${year}--,
                formatted: ${String(month).padStart(2, '0')}//
            };
        }





            if (sanitized.length >= 3 && sanitized[0].length >= 30 && sanitized[1].length >= 30) {
                return parseTd1Mrz(sanitized.slice(0, 3));
            }

            return null;
        }

        let scanInProgress = false;

        function renderScanResult(licenseData, ageData) {
            const fullName = [licenseData.firstName, licenseData.middleName, licenseData.lastName]
                .filter(Boolean)
                .join(' ');

            ui.nameDiv.textContent = fullName || '--';
            ui.dobDiv.textContent = ageData.formatted;
            ui.ageDiv.textContent = `${ageData.age}`;

            if (ageData.iso) {
                licenseData.dob = ageData.iso;
            }

            if (ageData.age >= 21) {
                ui.ageStatusDiv.textContent = '21+ Verified';
                ui.ageStatusDiv.className = 'age-status approved';
            } else {
                ui.ageStatusDiv.textContent = 'Under 21';
                ui.ageStatusDiv.className = 'age-status denied';
            }

            ui.resultOverlay.classList.add('show');
        }

        async function handleValidatedLicense(licenseData, sourceLabel) {
            if (!licenseData.firstName && !licenseData.lastName) {
                throw new Error('Could not read name from document. Please rescan.');
            }

            if (!licenseData.dob) {
                throw new Error('Could not read date of birth. Please rescan.');
            }

            const ageData = calculateAge(licenseData.dob);
            if (!ageData) {
                throw new Error('Unable to calculate age. Try another scan.');
            }

            licenseData.source = sourceLabel;
            licenseData.documentType = licenseData.documentType || (sourceLabel === 'pdf417' ? 'drivers_license' : sourceLabel);
            renderScanResult(licenseData, ageData);

            const verification = await submitVerification(licenseData, ageData);

            if (verification?.banned) {
                showToast('ID is banned. Follow escalation protocol.', 'error');
                ui.statusLabel.textContent = 'Status: Banned ID';
                setVerificationState('Flagged', verification.bannedReason || 'Banned customer. Contact manager.');
                ui.completeSaleBtn.disabled = true;
                logFrontendEvent('warn', 'Verification flagged as banned', {
                    saleId: state.saleId,
                    verificationId: verification?.verificationId || null
                });
                return;
            }

            if (verification?.status === 'approved' && ageData.age >= 21) {
                logFrontendEvent('info', 'Completing sale request', {
                    saleId,
                    clerkId,
                    paymentType
                });
                setTimeout(async () => {
                    await completeSale(state.autoClose);
                }, 2000);
            }
        }



        async function handleMrzScan(lines) {
            if (scanInProgress) return;
            scanInProgress = true;
            try {
                if (cvRouter) await cvRouter.stopCapturing();

                const mrzData = parseMrz(lines);
                if (!mrzData) {
                    throw new Error('Unable to read MRZ. Please steady the document and rescan.');
                }

                if (!mrzData.dob && mrzData.dobFormatted) {
                    const [month, day, year] = mrzData.dobFormatted.split('/');
                    mrzData.dob = `${year}-${month}-${day}`;
                }

                await handleValidatedLicense(mrzData, mrzData.documentType || 'mrz');
            } catch (error) {
                console.error('MRZ scan error:', error);
                showToast(error.message || 'Unable to read MRZ. Adjust the document and try again.');
                logFrontendEvent('error', 'MRZ scan failed', {
                    error: error.message
                });
                if (cvRouter) await startScanning();
            } finally {
                scanInProgress = false;
            }
        }

        async function handleBarcodeScan(bytesToParse) {
            if (scanInProgress) return;
            scanInProgress = true;
            try {
                if (cvRouter) await cvRouter.stopCapturing();

                const parsedResult = await parser.parse(bytesToParse);
                if (parsedResult.exception) {
                    throw new Error('Unable to parse ID barcode');
                }

                const parsedInfo = JSON.parse(parsedResult.jsonString);
                logFrontendEvent('debug', 'Raw parsed license payload', {
                    saleId,
                    fields: parsedInfo?.ResultInfo ? parsedInfo.ResultInfo.length : 0
                });

                const licenseData = parseLicenseData(parsedInfo);
                logFrontendEvent('info', 'PDF417 scan parsed', {
                    saleId: state.saleId,
                    issuingCountry: licenseData.issuingCountry || null,
                    documentType: licenseData.documentType || 'unknown'
                });
                await handleValidatedLicense(licenseData, 'pdf417');
            } catch (error) {
                console.error('Scan error:', error);
                showToast(error.message || 'Scan failed. Adjust the ID and try again.');
                logFrontendEvent('error', 'PDF417 scan failed', {
                    error: error.message
                });
                if (cvRouter) await startScanning();
            } finally {
                scanInProgress = false;
            }
        }

        function openHelpModal() {
            if (ui.helpModal) {
                ui.helpModal.classList.add('show');
            }
        }

        function closeHelpModal() {
            if (ui.helpModal) {
                ui.helpModal.classList.remove('show');
            }
        }

        function openManualModal() {
            if (!ui.manualModal || !state.latestVerification) {
                showToast('Scan an ID before requesting an override.', 'error');
                return;
            }
            logFrontendEvent('info', 'Manual override modal opened', {
                saleId: state.saleId,
                verificationId: state.latestVerification?.verificationId || null
            });
            ui.manualModal.classList.add('show');
            if (ui.manualPinInput) ui.manualPinInput.focus();
        }

        function closeManualModal() {
            if (ui.manualModal) {
                ui.manualModal.classList.remove('show');
            }
        }



        async function initScanner() {
            try {
                parser = await Dynamsoft.DCP.CodeParser.createInstance();

                const cameraView = await Dynamsoft.DCE.CameraView.createInstance();
                cameraEnhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance(cameraView);
                cameraEnhancer.setResolution({ width: 1920, height: 1080 });
                ui.cameraViewContainer.appendChild(cameraView.getUIElement());

                cvRouter = await Dynamsoft.CVR.CaptureVisionRouter.createInstance();
                cvRouter.setInput(cameraEnhancer);

                const filter = new Dynamsoft.Utility.MultiFrameResultCrossFilter();
                filter.enableResultDeduplication('barcode', true);
                await cvRouter.addResultFilter(filter);

                cvRouter.addResultReceiver({
                    onDecodedBarcodesReceived: async (result) => {
                        if (!result.barcodeResultItems.length) return;
                        Dynamsoft.DCE.Feedback.beep();
                        await handleBarcodeScan(result.barcodeResultItems[0].bytes);
                    },
                    onTextLinesReceived: async (result) => {
                        if (!result?.textLineResultItems?.length) return;
                        const mrzLines = result.textLineResultItems.map((item) => item.text || '');
                        const parsed = parseMrz(mrzLines);
                        if (!parsed) return;
                        Dynamsoft.DCE.Feedback.beep();
                        await handleMrzScan(mrzLines);
                    }
                });

                let settings = await cvRouter.getSimplifiedSettings('ReadDenseBarcodes');
                settings.barcodeSettings.barcodeFormatIds = Dynamsoft.DBR.EnumBarcodeFormat.BF_PDF417;
                settings.barcodeSettings.localizationModes = [16, 2, 0, 0, 0, 0, 0, 0];
                settings.barcodeSettings.expectBarcodeCount = 1;
                await cvRouter.updateSettings('ReadDenseBarcodes', settings);

                try {
                    const mrzSettings = await cvRouter.getSimplifiedSettings('ReadMRZ');
                    if (mrzSettings?.textLineSettings) {
                        mrzSettings.textLineSettings.charHeightRangeMin = 5;
                        mrzSettings.textLineSettings.charHeightRangeMax = 80;
                    }
                    await cvRouter.updateSettings('ReadMRZ', mrzSettings);
                } catch (mrzError) {
                    console.warn('MRZ preset unavailable, using default settings', mrzError);
                }
                markScannerInitialized();
                logFrontendEvent('info', 'Scanner initialized', {
                    saleId: state.saleId,
                    clerkId: state.clerkId
                });
                return true;
            } catch (error) {
                console.error('Scanner init error:', error);
                showToast('Unable to initialize scanner: ' + error.message);
                logFrontendEvent('error', 'Scanner initialization failed', {
                    error: error.message
                });
                return false;
            }
        }


        async function startScanning() {
            try {
                resetResultOverlay();
                await cameraEnhancer.open();
                await cvRouter.startCapturing('ReadDenseBarcodes');
                try {
                    await cvRouter.startCapturing('ReadMRZ');
                } catch (err) {
                    console.warn('ReadMRZ template unavailable', err);
                }
                setVerificationState('Not verified', 'Hold the ID inside the frame. Barcode or MRZ will scan automatically.');
                ui.statusLabel.textContent = 'Status: Scanning...';
            } catch (error) {
                console.error('Start scanning error:', error);
                showToast('Unable to start camera: ' + error.message);
                logFrontendEvent('error', 'Start scanning failed', {
                    error: error.message
                });
            }
        }

        if (ui.helpButton) {
            ui.helpButton.addEventListener('click', () => {
                openHelpModal();
            });
        }

        if (ui.manualEntryButton) {
            ui.manualEntryButton.disabled = true;
            ui.manualEntryButton.addEventListener('click', () => {
                openManualModal();
            });
        }

        if (ui.closeHelpButton) {
            ui.closeHelpButton.addEventListener('click', () => {
                closeHelpModal();
            });
        }

        if (ui.manualCancelButton) {
            ui.manualCancelButton.addEventListener('click', () => {
                closeManualModal();
            });
        }

        if (ui.manualModal) {
            ui.manualModal.addEventListener('click', (event) => {
                if (event.target === ui.manualModal) {
                    closeManualModal();
                }
            });
        }

        if (ui.manualForm) {
            ui.manualForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                if (!state.latestVerification) {
                    showToast('No verification to override yet.', 'error');
                    return;
                }

                const managerPin = ui.manualPinInput ? ui.manualPinInput.value.trim() : '';
                const managerId = ui.manualManagerInput ? ui.manualManagerInput.value.trim() : '';
                const note = ui.manualNoteInput ? ui.manualNoteInput.value.trim() : '';

                if (!managerPin) {
                    showToast('Manager PIN is required.', 'error');
                    if (ui.manualPinInput) ui.manualPinInput.focus();
                    return;
                }

                try {
                    logFrontendEvent('info', 'Manual override submitted', {
                        saleId: state.saleId,
                        verificationId: state.latestVerification.verificationId,
                        managerId: managerId || null,
                        note: note || null
                    });

                    const response = await fetch(`${API_BASE}/sales/${saleId}/override`, {
                        method: 'POST',
                        headers: buildHeaders({ 'Content-Type': 'application/json' }),
                        body: JSON.stringify({
                            verificationId: state.latestVerification.verificationId,
                            managerPin,
                            managerId,
                            note
                        })
                    });

                    if (!response.ok) {
                        const payload = await response.json().catch(() => ({}));
                        throw new Error(payload.message || 'Unable to apply override.');
                    }

                    const payload = await response.json();
                    const updatedVerification = payload?.data?.verification || state.latestVerification;
                    setLatestVerification(updatedVerification);
                    updateManualEntryAvailability();
                    setVerificationState('Approved', 'Override recorded. Complete the sale now.');
                    ui.statusLabel.textContent = 'Status: Override approved';
                    ui.completeSaleBtn.disabled = false;
                    showToast('Override approved. Complete the sale.', 'info');
                    logFrontendEvent('info', 'Manual override approved', {
                        saleId: state.saleId,
                        verificationId: updatedVerification?.verificationId || null,
                        managerId: managerId || null,
                        note: note || null
                    });
                    closeManualModal();
                    if (ui.manualNoteInput) ui.manualNoteInput.value = '';
                    if (ui.manualManagerInput) ui.manualManagerInput.value = '';
                    await loadComplianceSnapshot();
                } catch (error) {
                    console.error('Override error', error);
                    showToast(error.message || 'Unable to apply override.');
                    logFrontendEvent('warn', 'Manual override failed', {
                        saleId: state.saleId,
                        verificationId: state.latestVerification?.verificationId || null,
                        error: error.message,
                        note: note || null
                    });
                } finally {
                    if (ui.manualPinInput) ui.manualPinInput.value = '';
                }
            });
        }

        if (ui.helpModal) {
            ui.helpModal.addEventListener('click', (event) => {
                if (event.target === ui.helpModal) {
                    closeHelpModal();
                }
            });
        }

        ui.scanAgainBtn.addEventListener('click', async () => {
            await startScanning();
        });

        ui.restartScanBtn.addEventListener('click', async () => {
            await startScanning();
        });

        ui.completeSaleBtn.addEventListener('click', () => completeSale(state.autoClose));

        if (ui.refreshComplianceBtn) {
            ui.refreshComplianceBtn.addEventListener('click', () => {
                loadComplianceSnapshot();
            });
        }

        window.addEventListener('beforeunload', () => {
            if (cvRouter) cvRouter.stopCapturing();
            if (cameraEnhancer) cameraEnhancer.close();
            if (healthInterval) clearInterval(healthInterval);
        });

        (async function init() {
            await loadSale();
            updateManualEntryAvailability();
            await loadComplianceSnapshot();
            const initialized = await initScanner();
            if (initialized) {
                await startScanning();
                notifyIntegration('scanner_ready', {
                    autoClose: state.autoClose
                });
            }
        })();
    })();
    </script>
</body>
</html>




























